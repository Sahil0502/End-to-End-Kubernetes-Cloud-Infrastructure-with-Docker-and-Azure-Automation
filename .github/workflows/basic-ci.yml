name: Basic CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test-and-validate:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run tests
      run: npm test
    
    - name: Build Docker image (local test)
      run: |
        docker build . -t k8s-azure-app:test
        echo "✅ Docker build successful"
    
    - name: Test Docker container
      run: |
        # Start container in background
        docker run -d -p 3000:3000 --name test-container k8s-azure-app:test
        
        # Wait for container to start
        sleep 5
        
        # Test endpoints
        curl -f http://localhost:3000/ || exit 1
        curl -f http://localhost:3000/health || exit 1
        curl -f http://localhost:3000/api/info || exit 1
        
        # Cleanup
        docker stop test-container
        docker rm test-container
        
        echo "✅ Container tests passed"
    
    - name: Validate Kubernetes manifests
      run: |
        # Install kubeval for manifest validation
        wget https://github.com/instrumenta/kubeval/releases/latest/download/kubeval-linux-amd64.tar.gz
        tar xf kubeval-linux-amd64.tar.gz
        sudo mv kubeval /usr/local/bin/
        
        # Validate manifests (ignore template variables)
        sed 's/\${ACR_NAME}/test-acr/g; s/\${IMAGE_TAG}/test-tag/g' k8s/deployment.yaml > k8s/deployment-test.yaml
        
        kubeval k8s/configmap.yaml
        kubeval k8s/deployment-test.yaml
        kubeval k8s/service.yaml
        kubeval k8s/ingress.yaml
        
        echo "✅ Kubernetes manifests are valid"
    
    - name: Validate Terraform
      run: |
        cd terraform
        
        # Create test terraform.tfvars
        cat > terraform.tfvars << EOF
        project_name = "test-project"
        location = "East US"
        environment = "test"
        EOF
        
        # Initialize and validate
        terraform init
        terraform validate
        terraform fmt -check
        
        echo "✅ Terraform configuration is valid"
    
    - name: Security scan
      run: |
        # Install and run basic security scan
        docker run --rm -v "$PWD":/src \
          securecodewarrior/docker-security-scan:latest \
          /src/Dockerfile || echo "Security scan completed"
        
        echo "✅ Security scan completed"

  setup-check:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Check project setup
      run: |
        echo "## 🚀 Project Setup Status" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Check required files
        echo "### Required Files:" >> $GITHUB_STEP_SUMMARY
        for file in Dockerfile package.json server.js; do
          if [ -f "$file" ]; then
            echo "- ✅ $file" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ❌ $file (missing)" >> $GITHUB_STEP_SUMMARY
          fi
        done
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Kubernetes Manifests:" >> $GITHUB_STEP_SUMMARY
        for file in k8s/deployment.yaml k8s/service.yaml k8s/ingress.yaml k8s/configmap.yaml; do
          if [ -f "$file" ]; then
            echo "- ✅ $file" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ❌ $file (missing)" >> $GITHUB_STEP_SUMMARY
          fi
        done
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Terraform Files:" >> $GITHUB_STEP_SUMMARY
        for file in terraform/main.tf terraform/variables.tf terraform/outputs.tf terraform/aks.tf; do
          if [ -f "$file" ]; then
            echo "- ✅ $file" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ❌ $file (missing)" >> $GITHUB_STEP_SUMMARY
          fi
        done
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Next Steps:" >> $GITHUB_STEP_SUMMARY
        echo "1. 📋 Review the [GitHub Secrets Setup Guide](./GITHUB_SECRETS_SETUP.md)" >> $GITHUB_STEP_SUMMARY
        echo "2. 🔐 Configure Azure authentication secrets" >> $GITHUB_STEP_SUMMARY
        echo "3. 🏗️ Deploy infrastructure using Terraform" >> $GITHUB_STEP_SUMMARY
        echo "4. 🚀 Enable full CI/CD pipeline" >> $GITHUB_STEP_SUMMARY
